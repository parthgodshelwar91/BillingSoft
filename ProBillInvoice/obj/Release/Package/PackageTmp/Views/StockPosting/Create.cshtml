@using ProBillInvoice;
@model StStockHeader_StockPostingModel

@{
    ViewBag.Title = "Create";
    int SrNo = 0;
}

<style>
    .swal-color-red .swal-icon {
        color: red;
    }
</style>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    <div class="form-horizontal">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-sm-6">
                                <h4 class="card-title mb-0 page-heading-color">Stock Opening - Create </h4>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="form-group">
                            <div class="row mb-2">
                                <fieldset>
                                    <div class="table-responsive" style="height: 400px;">
                                        <table id="StockHeader" class="table table-bordered table-hover table-responsive table-striped align-middle table-rmc table-sm" style="width:100%">
                                            <thead>
                                                <tr>
                                                    <th>Item Name</th>
                                                    <th>Unit</th>
                                                    <th>Site Name</th>
                                                    <th>Store Name</th>
                                                    <th>Rack Name</th>
                                                    <th style="text-align:right">Op Qty</th>
                                                    <th style="text-align:right">Rate</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>

                                            @if (Model.StStockHeader != null)
                                            {
                                                for (var i = 0; i < Model.StStockHeader.Count(); i++)
                                                {
                                                    SrNo = SrNo + 1;
                                            <tr>
                                                <td>@Html.DropDownListFor(x => Model.StStockHeader[i].material_id, new SelectList(ViewBag.MaterialList, "Value", "Text", Model.StStockHeader[i].material_id), "--Select--", new { @class = "form-select", @onchange = "UnitList(" + i + ");" })</td>
                                                <td>@Html.DropDownListFor(x => Model.StStockHeader[i].unit_code, new SelectList(ViewBag.UnitList, "Value", "Text", Model.StStockHeader[i].unit_code), "--Select--", new { @class = "form-select" })</td>
                                                <td>@Html.DropDownListFor(x => Model.StStockHeader[i].site_id, new SelectList(ViewBag.SiteList, "Value", "Text", Model.StStockHeader[i].site_id), "--Select--", new { @class = "form-select" })</td>
                                                <td>@Html.DropDownListFor(x => Model.StStockHeader[i].store_id, new SelectList(ViewBag.StoreList, "Value", "Text", Model.StStockHeader[i].store_id), "--Select--", new { @class = "form-select" })</td>
                                                <td>@Html.DropDownListFor(x => Model.StStockHeader[i].rack_id, new SelectList(ViewBag.RackList, "Value", "Text", Model.StStockHeader[i].rack_id), "--Select--", new { @class = "form-select" })</td>
                                                <td style="width: 150px;">@Html.TextBoxFor(x => Model.StStockHeader[i].opening_qty, new { @class = "form-control", @style = "text-align: right; color: maroon;" })</td>
                                                <td style="width: 150px;">@Html.TextBoxFor(x => Model.StStockHeader[i].item_avg_rate, new { @class = "form-control", @style = "text-align: right; color: green;" })</td>

                                                @Html.HiddenFor(x => Model.StStockHeader[i].st_stock_header_id)
                                                @Html.HiddenFor(x => Model.StStockHeader[i].material_id)
                                                @Html.HiddenFor(x => Model.StStockHeader[i].unit_code)
                                                @Html.HiddenFor(x => Model.StStockHeader[i].brand_id)
                                                @Html.HiddenFor(x => Model.StStockHeader[i].site_id)
                                                @Html.HiddenFor(x => Model.StStockHeader[i].rack_id)
                                                @Html.HiddenFor(x => Model.StStockHeader[i].store_id)
                                                <td style="text-align: center;">
                                                    <button type="submit" id="btndeleteSP" class="btn btn-danger btn-sm custom-toggle" name="btndeleteSP" value="@(i)" formaction='@Url.Action("Create", "StockPosting")' title="Click here to Delete row"><i class="ri-close-line"></i></button>
                                                </td>
                                            </tr>
                                                }
                                            }
                                        </table>
                                        <div class="row">
                                            <div class="col-md-8">
                                                <button type="submit" id="btnAdd" class="btn btn-primary addMembers-modal" name="btnAdd" value="Add"  title="Click here to Add" onclick="return  Validation();"><div style="float: left;"><i class="bx bx-plus fs-16 me-2"></i></div>Add</button>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>

                            <div class="bottom-save-cancel-btn">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <a href="@Url.Action("Create", "StockPosting")" class="refresh-btn"  title="Click here to Refresh"><i class="bx bx-rotate-right"></i>Refresh</a>
                                    </div>
                                    <div class="col-sm-6">
                                        <a href="@Url.Action("Index", "StockPosting")" class="back-btn"  title="Click here to Back"><i class="las la-arrow-circle-left"></i>Back</a>
                                        <button type="submit" id="btnAdd" class="save-data-btn" name="btnAdd" value="Save"  title="Click here to Save" onclick="return Validation();"><i class="ri-save-line"></i>Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
@if (ViewBag.Message != null)
{
    <script>
        window.onload = function () {
            Swal.fire({
                title: "<span style='color: #3085d6;'>@Html.Raw(ViewBag.Message)</span>",
                icon: "success",
                iconColor: "#04AA6D",
                confirmButtonClass: "w-xs me-2 mt-2",
                confirmButtonColor: "#3085d6",

            }).then((result) => {
                if (result.value) {
                    window.location.href = "@Url.Action("Index", "StockPosting")";
                }
            });
        } ;
    </script>
}

@if (TempData["ErrorMsg"] != null)
{
    <script>
            window.onload = function () {
                Swal.fire({
                    text: "@TempData["ErrorMsg"]",
                    icon: "error",
                    confirmButtonClass: "btn btn-primary w-xs me-2 mt-2",
                    customClass: {
                        icon: 'swal-color-red'
                    }
                })
            };
    </script>
}
@section Scripts {

    <script>
        function UnitList(val) {
            var selectedValue;
            $("#StockHeader tr").each(function () {
                //debugger;
                var selectedText = $("#StStockHeader_" + val.toString() + "__material_id").find("option:selected").text();
                selectedValue = $("#StStockHeader_" + val.toString() + "__material_id").val();

                var Parameter = {
                    ItemCode: selectedValue,
                    ItemName: selectedText
                };
                $.ajax({
                    type: "POST",
                    url: "/StockPosting/FillByUnitCode",
                    data: JSON.stringify(Parameter),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        data.List;
                        var items = '';
                        $.each(data.List, function (i, Unit) {
                            items += "<option value='" + Unit.Value + "'>" + Unit.Text + "</option>";
                        });
                        $("#StStockHeader_" + val.toString() + "__unit_code").html(items);
                    },
                    error: function () {
                        alert("Error occured!!")
                    }
                });
            });
        }
    </script>

    @*<script type="text/javascript">
            function Validation() {
                var rowCount = $("#StockHeader tr").length;
                var i = 0;
                var foundDuplicate = false;
                var currentValue = 0;
                var NewValue = 0;

                if (rowCount > 2) {
                    $("#StockHeader tr").each(function () {
                         currentValue = $("#StockHeader_" + i + "__material_id").val();

                        var j = 0;
                        $("#StockHeader tr").each(function () {
                            debugger;
                            if (i != j && foundDuplicate == false) {
                                NewValue = $("#StockHeader_" + j + "__material_id").val();
                                if (NewValue == currentValue) {
                                    alert("Duplicate Record found!");
                                    foundDuplicate = true;
                                    return false;
                                }
                                else {
                                    return true;
                                }
                            }
                            j++;
                        })
                        i++;
                    });
                }
                else {
                    foundDuplicate = false;
                }
                return !foundDuplicate;

            }
        </script>*@

    @*<script>
            $(document).ready(function () {
                $("#material_id").change(function () {
                    var selectedText = $(this).find("option:selected").text();
                    var selectedValue = $(this).val();

                    var lsParameter = {
                        MaterialID: selectedValue,
                        MaterialName: selectedText
                    };
                    $.ajax({
                        type: "POST",
                        url: "/StockPosting/UnitCode",
                        data: JSON.stringify(lsParameter),
                        contentType: 'application/json; charset=utf-8',
                        success: function (data) {
                            UnitCode = data.msg.split("|")[0];
                            $('#lblUnitCode').text(UnitCode);
                        },
                        error: function () {
                            alert("Error occured!!")
                        }
                    });
                })
            })
        </script>*@
}

@*<script>

        $(document).ready(function () {
            //debugger;
            $("#material_id").change(function () {
                var selectedText = $(this).find("option:selected").text();
                var selectedValue = $(this).val();

                var lsParameter = {
                    MaterialID: selectedValue,
                    MaterialName: selectedText
                };
                $.ajax({
                    type: "POST",
                    url: "/StockPosting/ShortDesc",
                    data: JSON.stringify(lsParameter),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        var ShortDesc = data.msg.split("|")[0];
                        $('#UnitDescription').text(ShortDesc);

                    },
                    error: function () {
                        alert("Error occurred!");
                    }
                });
            });
            $("#material_id").change();
        });
    </script>*@